<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Drag and Drop Rooms</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 0;
    }

    .room-labels {
      display: flex;
      justify-content: center;
      margin: 1rem;
    }

    .label-slot {
      /*width: 300px;*/
      min-height: 40px;
      border: 2px dashed #aaa;
      margin: 1rem;
      margin-bottom: 0rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f0f0f0;
      flex-direction: column;
    }
    
    .capacityLabel {
      margin-top: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .label {
      padding: 5px 10px;
      background-color: #ffde59;
      border: 1px solid #aaa;
      cursor: move;
      display: flex;
      align-items: center;
      flex-direction: column;
    }

    .rooms {
      min-width: 300px;
      display: flex;
      justify-content: space-around;
      width: 100%;
      padding: 0rem;
    }

    .room {
      width: 300px;
      min-height: 400px;
      border: 2px solid #333;
      padding: 10px 10px 40px 10px; /* extra bottom padding */
      background-color: #f9f9f9;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin: 0px 0px 10px 0px;
    }
    
    

    .topic-box {
      border: 2px solid #4caf50;
      padding: 10px 10px 20px 10px;
      min-height: 10px;
      cursor: move;
    }

    .topic-title {
      /*font-weight: bold;*/
      margin-bottom: 8px;
    }

    .item {
      border: 1px solid #555;
      padding: 5px;
      margin: 5px 0;
      cursor: move;
    }
  </style>
</head>
<body>
  <!--<div class="room-labels" id="room-labels">
    <!-- Labels dynamically inserted here
  </div>-->

  <div class="rooms" id="rooms-container">
    <!-- Rooms will be populated here from JS -->
  </div>

  <button id="generate" style="display: none;" onclick="generateSchedules()">Generate schedules</button>
  
  <script>
    /*const initRoomDistribution = {
      "Room Alpha": [
        ["Solar Energy", [["Alice", "Panels"], ["Bob", "Mirrors"]]],
        ["AI", [["Cara", "Chatbots"], ["Dan", "Vision"]]]
      ],
      "Room Beta": [
        ["Gaming", [["Eva", "Wii"], ["Frank", "Switch"]]],
        ["Music", [["George", "Guitar"], ["Holly", "Piano"]]]
      ],
      "Room Gamma": [
        ["Art", [["Iris", "Painting"], ["Jack", "Sculpture"]]]
      ],
      "Room Delta": [
        ["Sports", [["Karen", "Tennis"], ["Leo", "Basketball"]]]
      ]
    };
    const capacityDict={"Room Alpha": 0, "Room Beta": 6, "Room Gamma":4, "Room Delta": 4};*/
    const capacityDict={};
	  
    fetch('/get_data')
    .then(res => res.json())
    .then(data => {
      capacityDict=data.capacityDict;
      createRoomElements(data.realInitRoomDistribution);
      document.getElementById("generate").style.display = "block";
      // You can store or log `data.backupRoomDict` if needed
    })
    .catch(err => console.error("Failed to fetch room data:", err));

    const topicColors = [
      "#ffcccc", "#ccffff", "#ccffcc", "#ffe0b3", "#e0ccff",
      "#ffffcc", "#ccffe6", "#ffd9ec", "#d6f5d6", "#ebd6ff",
      "#ffebcc", "#e6f7ff", "#f0fff0", "#fff5cc", "#f5e6ff",
      "#ffe6e6", "#e0ffe0", "#f9f9cc", "#e6e6ff", "#e0f7fa"
    ];
    const topicColorMap = {};
    let colorIndex = 0;
    var allTopics={};
    var allTopicNames=[]
    
    var allRoomNames=[];
    var allRooms={};
    
    //var allTopicBoxes=[];
    //var allTopicNumbers=[];
    
    
    
    function createRoomElements(initRoomDistribution) {
      //const labelContainer = document.getElementById("room-labels");
      //labelContainer.innerHTML = "";
      const roomContainer = document.getElementById("rooms-container");
      roomContainer.innerHTML = "";
      var crest=0;
      
      Object.entries(initRoomDistribution).forEach(([roomName, topics], i) => {
        const labelSlot = document.createElement("div");
        labelSlot.className = "label-slot";
        labelSlot.ondrop = drop;
        labelSlot.ondragover = allowDrop;

        const label = document.createElement("div");
        label.className = "label";
        label.draggable = true;
        label.id = `label-${roomName.replace(/\s+/g, '-')}`;
        label.ondragstart = drag;
        label.innerText = roomName;
        
        const capacityLabel = document.createElement("div");
        capacityLabel.innerText = "max capacity: "+capacityDict[roomName];
        capacityLabel.className = "capacityLabel";
        capacityLabel.id=`label-${roomName.replace(/\s+/g, '-')}`+"CAPACITY";
        
		const currentCapacityLabel = document.createElement("div");
        currentCapacityLabel.innerText = "currently holding: "+0;
        currentCapacityLabel.className = "capacityLabel";
        currentCapacityLabel.style.fontSize="18px";
        currentCapacityLabel.id=`label-${roomName.replace(/\s+/g, '-')}`+"CURRENTCAPACITY";
        
        
        labelSlot.appendChild(label);
        //labelContainer.appendChild(labelSlot);

        const roomDiv = document.createElement("div");
        roomDiv.className = "room";
        roomDiv.id = `room${i+1}`;
        roomDiv.ondrop = drop;
        roomDiv.ondragover = allowDrop;
		roomDiv.append(labelSlot);
        
        label.append(capacityLabel);
        roomDiv.append(currentCapacityLabel);
      
      	allRoomNames.push(roomName);
      	allRooms[roomName]=[roomDiv,currentCapacityLabel,0];
   
        topics.forEach(([topic, items]) => {
          //const topicId = `${roomDiv.id}-${topic.replace(/\s+/g, '-')}`;
          //allTopics.push(topic);
          const topicId = "pranavi"+topic;
          if (!topicColorMap[topic]) {
            topicColorMap[topic] = topicColors[colorIndex % topicColors.length];
            colorIndex++;
          }

          const topicDiv = document.createElement("div");
          topicDiv.className = "topic-box";
          topicDiv.style.backgroundColor = topicColorMap[topic];
          topicDiv.draggable = true;
          topicDiv.id = topicId;
          topicDiv.ondragstart = drag;

          /*var title = document.createElement("div");
          title.className = "topic-title";
          title.innerText = topic;
          topicDiv.appendChild(title);*/
          
          var topicNumber = 0;
          allTopics[topic]=[topicDiv,topicNumber];
          allTopicNames.push(topic);
          var topicBoxState = document.createElement("div");
          topicBoxState.className = "topic-title";
          
          if (crest==0) {
          	topicBoxState.innerHTML = "<b>"+topic+" ("+topicNumber+")</b> [hide]";
          }
          else {
          	topicBoxState.innerHTML = "<b>"+topic+" ("+topicNumber+")</b> [expand]";
          }
          topicDiv.appendChild(topicBoxState);

          items.forEach(([person, project]) => {
            const itemDiv = document.createElement("div");
            itemDiv.className = "item";
            itemDiv.style.backgroundColor = topicColorMap[topic];
            itemDiv.draggable = true;
            itemDiv.id = `${person.toLowerCase()}-${project.toLowerCase()}`;
            itemDiv.ondragstart = drag;
            itemDiv.innerHTML = `${person}<br />${project}`;
            if (crest!=0) {
       			itemDiv.style.display="none";
            }
            topicDiv.appendChild(itemDiv);
            itemDiv.classList.add("class");
          });
          
          
          
          topicDiv.addEventListener("click", function showHideProjects() {
          	var allElements = topicDiv.querySelectorAll(".item");
            var bob = true;
            console.log(allElements);
            var newtopicNumber = allTopics[topic][1];
            if (topicBoxState.innerText.includes("expand")) {
                topicBoxState.innerHTML = "<b>"+topic+" ("+newtopicNumber+")</b> [hide]";
            }
            else {
                topicBoxState.innerHTML = "<b>"+topic+" ("+newtopicNumber+")</b> [expand]";
                bob = false;
            }
          	for (var project of allElements) {
                if (bob) {
                	project.style.display = "block";
                }
                else {
                	project.style.display = "none";
                };
            }
            //title.style.display="block";
            topicBoxState.style.display="block";
            
          });
          //updateNumbers(topic);
          roomDiv.appendChild(topicDiv);
        });
        if (crest==0) {
        	roomDiv.style.marginRight="50px";
        }
		crest++;
        roomContainer.appendChild(roomDiv);
      });
      updateAllNumbers();
    }
	
    function updateNumbers(topic) {
      console.log(allTopics);
      
      var topicBox = allTopics[topic][0];
      var topicNumber = topicBox.querySelectorAll(".item").length;
      //console.log(topicBox.querySelectorAll(".item"));
      var topicBoxState = topicBox.querySelector(".topic-title");
      //console.log(topicBoxState);
      if (topicBoxState.innerText.includes("expand")) {
        topicBoxState.innerHTML = "<b>"+topic+" ("+topicNumber+")</b> [expand]";
      }
      else {
        topicBoxState.innerHTML = "<b>"+topic+" ("+topicNumber+")</b> [hide]";
      }
      allTopics[topic][1]=topicNumber;
    }
    
    function updateAllNumbers() {
    
    	var bub = true;
        allTopicNames.forEach((topic) => {
        	updateNumbers(topic);
        });
        
        allRoomNames.forEach((room) => {
        	var currentRoom = allRooms[room][0];
        	var currentRoomCapacityLabel=allRooms[room][1];
            var currentRoomCapacity = currentRoom.querySelectorAll(".item").length;
            currentRoomCapacityLabel.innerText = "currently holding: "+currentRoomCapacity;
            if (currentRoomCapacity>capacityDict[room]) {
            	currentRoomCapacityLabel.style.color="red";
                bub=false;
            }
            else {
            	currentRoomCapacityLabel.style.color="black";
            }
            allRooms[room][2]=currentRoomCapacity;
        });
        if (bub==true) {
        	document.getElementById("generate").disabled=false;
        }
        else {
        	document.getElementById("generate").disabled=true;
        }
    }
    
    function allowDrop(ev) {
      ev.preventDefault();
    }

    function drag(ev) {
      ev.dataTransfer.setData("text", ev.target.id);
    }

    function drop(ev) {
      ev.preventDefault();
      const data = ev.dataTransfer.getData("text");
      const draggedEl = document.getElementById(data);

      //if (!draggedEl || ev.target.contains(draggedEl)) return;

      let dropTarget = ev.target;
      while (dropTarget && !dropTarget.classList.contains("room") &&
             !dropTarget.classList.contains("topic-box") &&
             !dropTarget.classList.contains("label-slot") &&
             !dropTarget.classList.contains("item") &&
             !dropTarget.classList.contains("label")) {
        dropTarget = dropTarget.parentElement;
      }

		
      // Item drag
      if (draggedEl.classList.contains("item") && dropTarget.classList.contains("room")) {
        dropTarget.appendChild(draggedEl);
        updateAllNumbers();
        return;
      }
      
      // Item drag
      if (draggedEl.classList.contains("item") && dropTarget.classList.contains("topic-box")) {
        //dropTarget.appendChild(draggedEl);
        if (!dropTarget.classList.contains("item") && dropTarget.querySelectorAll(".item").length != 0) {
        	dropTarget.parentElement.insertBefore(draggedEl, dropTarget);
        }
        else {
        	dropTarget.appendChild(draggedEl);
        }
        updateAllNumbers();
        return;
      }

      // Topic-box drag
      if (draggedEl.classList.contains("topic-box") && dropTarget.classList.contains("room")) {
        dropTarget.appendChild(draggedEl);
        updateAllNumbers();
        return;
      }
      
      //no topic box in topic box!!!!!!
      if ((draggedEl.classList.contains("topic-box")) &&
          (dropTarget.classList.contains("item"))) {
        return;
      }
      
      // Insert above if dropped on another draggable element
      if ((draggedEl.classList.contains("item") || draggedEl.classList.contains("topic-box")) &&
          (dropTarget.classList.contains("item") || dropTarget.classList.contains("topic-box"))) {
        dropTarget.parentElement.insertBefore(draggedEl, dropTarget);
        updateAllNumbers();
        return;
      }

      // Label drag
      if (draggedEl.classList.contains("label") && dropTarget.classList.contains("label-slot")) {
        dropTarget.appendChild(draggedEl);
        updateAllNumbers();
        return;
      }
      
      
      //Label drag onto another label
      if (draggedEl.classList.contains("label") && dropTarget.classList.contains("label")) {
        dropTarget.parentElement.insertBefore(draggedEl, dropTarget);
        return;
      }
      
    }

    // Initialize page
    /*createRoomElements(initRoomDistribution);
	document.getElementById("generate").style.display = "block";
	console.log(allTopics);*/
    
    function generateSchedules() {
      const roomDict = {};
    
      allRoomNames.forEach(room => {
        /*const roomName = room.getAttribute("data-room-name") || room.querySelector(".room-label")?.innerText?.trim();
        const people = [];
    
        // Get all direct children with class 'item' (skip topic-box etc.)
        room.querySelectorAll(":scope > .item").forEach(item => {
          // Only grab the name before the colon, assuming format is "Name: Project"
          const fullText = item.innerText.trim();
          const nameOnly = fullText.split(":")[0].trim();
          people.push(nameOnly);
        });
    
        if (roomName) {
          roomDict[roomName] = people;
        }*/
        roomDict[room]=[];
        allRooms[room][0].querySelectorAll(".item").forEach(item => {
        	item.style.display="block";
        	console.log(item.innerText.split("\n"));
        	roomDict[room].push(item.innerText.split("\n")[0]);
        });
      });
      console.log(JSON.stringify(roomDict));
      
      
      // Send to backend
      fetch('/receive_schedule', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(roomDict)
      })
      .then(res => res.json())
      .then(data => console.log("Success:", data))
      .catch(err => console.error("Error sending schedule:", err));
    }
  </script>
</body>
</html>
