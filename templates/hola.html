<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Drag and Drop Rooms</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 0;
    }

    .room-labels {
      display: flex;
      justify-content: center;
      margin: 1rem;
    }

    .label-slot {
      width: 300px;
      height: 40px;
      border: 2px dashed #aaa;
      margin: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f0f0f0;
    }

    .label {
      padding: 5px 10px;
      background-color: #ffde59;
      border: 1px solid #aaa;
      cursor: move;
    }

    .rooms {
      display: flex;
      justify-content: space-around;
      width: 100%;
      padding: 2rem;
    }

    .room {
      width: 300px;
      min-height: 400px;
      border: 2px solid #333;
      padding: 10px 10px 20px 10px; /* extra bottom padding */
      background-color: #f9f9f9;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    

    .topic-box {
      border: 2px solid #4caf50;
      padding: 10px 10px 20px 10px;
      min-height: 100px;
      cursor: move;
    }

    .topic-title {
      font-weight: bold;
      margin-bottom: 8px;
    }

    .item {
      border: 1px solid #555;
      padding: 5px;
      margin: 5px 0;
      cursor: move;
    }
  </style>
</head>
<body>
  <div class="room-labels" id="room-labels">
    <!-- Labels dynamically inserted here -->
  </div>

  <div class="rooms" id="rooms-container">
    <!-- Rooms will be populated here from JS -->
  </div>

  <script>
    /*const initRoomDistribution = {
      "Room Alpha": [
        ["Solar Energy", [["Alice", "Panels"], ["Bob", "Mirrors"]]],
        ["AI", [["Cara", "Chatbots"], ["Dan", "Vision"]]]
      ],
      "Room Beta": [
        ["Gaming", [["Eva", "Wii"], ["Frank", "Switch"]]],
        ["Music", [["George", "Guitar"], ["Holly", "Piano"]]]
      ],
      "Room Gamma": [
        ["Art", [["Iris", "Painting"], ["Jack", "Sculpture"]]]
      ],
      "Room Delta": [
        ["Sports", [["Karen", "Tennis"], ["Leo", "Basketball"]]]
      ]
    };*/

    fetch('/get_data')
    .then(res => res.json())
    .then(data => {
      createRoomElements(data.realInitRoomDistribution);
      // You can store or log `data.backupRoomDict` if needed
    })
    .catch(err => console.error("Failed to fetch room data:", err));

    const topicColors = [
      "#ffcccc", "#ccffff", "#ccffcc", "#ffe0b3", "#e0ccff",
      "#ffffcc", "#ccffe6", "#ffd9ec", "#d6f5d6", "#ebd6ff",
      "#ffebcc", "#e6f7ff", "#f0fff0", "#fff5cc", "#f5e6ff",
      "#ffe6e6", "#e0ffe0", "#f9f9cc", "#e6e6ff", "#e0f7fa"
    ];
    const topicColorMap = {};
    let colorIndex = 0;

    function createRoomElements(initRoomDistribution) {
      const labelContainer = document.getElementById("room-labels");
      labelContainer.innerHTML = "";
      const roomContainer = document.getElementById("rooms-container");
      roomContainer.innerHTML = "";

      Object.entries(initRoomDistribution).forEach(([roomName, topics], i) => {
        const labelSlot = document.createElement("div");
        labelSlot.className = "label-slot";
        labelSlot.ondrop = drop;
        labelSlot.ondragover = allowDrop;

        const label = document.createElement("div");
        label.className = "label";
        label.draggable = true;
        label.id = `label-${roomName.replace(/\s+/g, '-')}`;
        label.ondragstart = drag;
        label.innerText = roomName;

        labelSlot.appendChild(label);
        labelContainer.appendChild(labelSlot);

        const roomDiv = document.createElement("div");
        roomDiv.className = "room";
        roomDiv.id = `room${i+1}`;
        roomDiv.ondrop = drop;
        roomDiv.ondragover = allowDrop;

        topics.forEach(([topic, items]) => {
          const topicId = `${roomDiv.id}-${topic.replace(/\s+/g, '-')}`;
          if (!topicColorMap[topic]) {
            topicColorMap[topic] = topicColors[colorIndex % topicColors.length];
            colorIndex++;
          }

          const topicDiv = document.createElement("div");
          topicDiv.className = "topic-box";
          topicDiv.style.backgroundColor = topicColorMap[topic];
          topicDiv.draggable = true;
          topicDiv.id = topicId;
          topicDiv.ondragstart = drag;

          const title = document.createElement("div");
          title.className = "topic-title";
          title.innerText = topic;
          topicDiv.appendChild(title);

          items.forEach(([person, project]) => {
            const itemDiv = document.createElement("div");
            itemDiv.className = "item";
            itemDiv.style.backgroundColor = topicColorMap[topic];
            itemDiv.draggable = true;
            itemDiv.id = `${person.toLowerCase()}-${project.toLowerCase()}`;
            itemDiv.ondragstart = drag;
            itemDiv.innerHTML = `${person}<br />${project}`;
            topicDiv.appendChild(itemDiv);
          });

          roomDiv.appendChild(topicDiv);
        });

        roomContainer.appendChild(roomDiv);
      });
    }

    function allowDrop(ev) {
      ev.preventDefault();
    }

    function drag(ev) {
      ev.dataTransfer.setData("text", ev.target.id);
    }

    function drop(ev) {
      ev.preventDefault();
      const data = ev.dataTransfer.getData("text");
      const draggedEl = document.getElementById(data);

      if (!draggedEl || ev.target.contains(draggedEl)) return;

      let dropTarget = ev.target;
      while (dropTarget && !dropTarget.classList.contains("room") &&
             !dropTarget.classList.contains("topic-box") &&
             !dropTarget.classList.contains("label-slot") &&
             !dropTarget.classList.contains("item") &&
             !dropTarget.classList.contains("label")) {
        dropTarget = dropTarget.parentElement;
      }

      // Item drag
      if (draggedEl.classList.contains("item") && (dropTarget.classList.contains("room") || dropTarget.classList.contains("topic-box"))) {
        dropTarget.appendChild(draggedEl);
        return;
      }
      
      // Insert above if dropped on another draggable element
      if ((draggedEl.classList.contains("item") || draggedEl.classList.contains("topic-box")) &&
          (dropTarget.classList.contains("item") || dropTarget.classList.contains("topic-box"))) {
        dropTarget.parentElement.insertBefore(draggedEl, dropTarget);
        return;
      }

      // Label drag
      if (draggedEl.classList.contains("label") && dropTarget.classList.contains("label-slot")) {
        dropTarget.appendChild(draggedEl);
        return;
      }

      // Topic-box drag
      if (draggedEl.classList.contains("topic-box") && dropTarget.classList.contains("room")) {
        dropTarget.appendChild(draggedEl);
        return;
      }
    }

    // Initialize page
    //createRoomElements(initRoomDistribution);
  </script>
</body>
</html>
