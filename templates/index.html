<!DOCTYPE html>
<html>
<head>
    <title>Google Sheets Link</title>
    <style>
        .columnnumbers {
            width: 30px;
            margin-right: 20px;
            margin-left: 5px;
        }
        .container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 5px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h2>Google Spreadsheet Info</h2>
    <input id="spreadsheetUrl" type="text" name="url" style="width:1000px;" placeholder="Paste spreadsheet csv here...">
    
    <p>Number of column containing...</p>
    <form class="container" id="columnForm">
        <p>Last name</p> <input type="number" class="columnnumbers" placeholder="1">
        <p>First name</p> <input type="number" class="columnnumbers" placeholder="2">
        <p>Name of project</p> <input type="number" class="columnnumbers" placeholder="3">
        <p>Project topic</p> <input type="number" class="columnnumbers" placeholder="4">
        <p>Availability</p> <input type="number" class="columnnumbers" placeholder="5">
        <p>Presenting with friend(s)</p> <input type="number" class="columnnumbers" placeholder="6">
        <p>Blurb about project</p> <input type="number" class="columnnumbers" placeholder="7">
    </form>

    <h2>Rooms</h2>
    <p>Enter the name of each room on a separate line</p>
    <textarea id="roomsInput" style="width:200px" rows="5"></textarea>

    <h2>All possible times</h2>
    <p>Enter these <i>exactly as they are written</i> as options for the availability question in the Google Form, each time on a separate line</p>
    <p>Once you press submit you will be able to select which rooms are available at each time.</p>
    <textarea id="timesInput" style="width:400px" rows="15"></textarea>

    <br><br>
    <button onclick="generateTable()">Submit</button>

    <br><br>
    <div id="tableContainer"></div>

  	<br>
    <button id="sendBackend" style="display: none;" onclick="submitAvailability()">Next</button>

    <h2>Rooms and Times Data</h2>
    <p><strong>Rooms to Times:</strong></p>
    <pre>{{ roomsToTimes }}</pre>

    <p><strong>All Times:</strong></p>
    <pre>{{ allTimes }}</pre>
    
    <script>
        function generateTable() {
            const rooms = document.getElementById('roomsInput').value.trim().split('\n').filter(x => x.trim() !== '');
            const times = document.getElementById('timesInput').value.trim().split('\n').filter(x => x.trim() !== '');

            const container = document.getElementById('tableContainer');
            container.innerHTML = "";

            // Save current checkbox states
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkboxStates[checkbox.dataset.key] = checkbox.checked;
            });

            if (rooms.length === 0 || times.length === 0) {
                container.innerHTML = "<p>Please enter at least one room and one time!</p>";
                return;
            }

            const table = document.createElement('table');

            // Header row
            const headerRow = document.createElement('tr');
            const cornerHeader = document.createElement('th'); 
            cornerHeader.innerText = "Time/Room";
            headerRow.appendChild(cornerHeader);

            rooms.forEach(room => {
                const th = document.createElement('th');
                th.innerText = room;
                headerRow.appendChild(th);
            });

            table.appendChild(headerRow);

            // Rows
            times.forEach(time => {
                const row = document.createElement('tr');
                const timeCell = document.createElement('th');
                timeCell.innerText = time;
                row.appendChild(timeCell);

                rooms.forEach(room => {
                    const cell = document.createElement('td');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    const key = `${room}|${time}`; 
                    checkbox.dataset.key = key;
                    
                    cell.appendChild(checkbox);
                    row.appendChild(cell);
                });

                table.appendChild(row);
            });

            container.appendChild(table);
            sendBackend.style.display = 'block';
        }

        function submitAvailability() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const roomsToTimes = {};

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    const room = cb.getAttribute('data-room');
                    const time = cb.getAttribute('data-time');
                    if (!roomsToTimes[room]) {
                        roomsToTimes[room] = [];
                    }
                    roomsToTimes[room].push(time);
                }
            });

            const allTimes = document.getElementById('timesInput').value.trim().split('\n').map(t => t.trim()).filter(t => t !== '');

            fetch('/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    roomsToTimes: roomsToTimes,
                    allTimes: allTimes
                })
            })
            .then(response => response.text())
            .then(data => {
                console.log('Server response:', data);
                alert('Data sent successfully!');
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }
    </script>
</body>
</html>
