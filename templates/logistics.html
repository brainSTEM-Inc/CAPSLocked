
<!DOCTYPE html>
<html>
<head>
    <title>Google Sheets Link</title>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&display=swap" rel="stylesheet">
    <style>
    :root {
      --base-color: linear-gradient(180deg, #360000, #130101);
      --text-color: white;
      --buttoncolor: #B51111;
      --fill-color: #fff7f7;
      --base-variant: #ff2222;
    }

    html.sunlight {
      --base-color: linear-gradient(180deg, #fff6eeff, #ffded9 );
      --text-color: black;
      --buttoncolor: #f1bfbf;
      --fill-color: #550000;
      --base-variant: #edbfbf;
    }
        body {
            background-image: var(--base-color);
            display: flex;
            justify-content: center; /* vertical */
            flex-direction: column;
            height: 100vh;
        }
        .button-wrapper {
            text-align: center;
            width: 100%;
        }
        .columnnumbers {
            width: 30px;
            margin-right: 20px;
            margin-left: 5px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 30px;
            padding: 20px;
            margin: auto;
            max-width: 90vw;
            overflow-x: auto;
            background-color: #c6afaf;
            width: 80%;
            border-radius: 12px;
        }
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 5px;
            text-align: center;
            background-color: white;
        }
        .button {
          background-color: #b51111;
          color: white;
          font-size: 20px;
          padding: 15px;
          width: 30%;
          border: none;
          border-radius: 12px;
          font-weight: bold;
          cursor: pointer;
        }
        .button:hover {
          background-color: #9f0f0f;
          transition: transform 0.3s ease;
          transform: scale(1.1);
        }
        input[type="text"] {
          width: 100px;
          padding: 5px;
          font-size: 20px;
          border: none;
          background-color: #fff;
          color: #444;
          box-sizing: border-box;
        }
         /* Theme toggle button */
#theme-switch {
  height: 50px;
  width: 50px;
  padding: 0;
  border-radius: 50%;
  background-color: var(--base-variant);
  display: flex;
  justify-content: center;
  align-items: center;
  position: fixed;
  top: 20px;
  right: 20px;
  cursor: pointer;
  border: none;
}

/* Hide all icons by default */
#theme-switch svg {
  display: none;
  fill: var(--fill-color);
}

/* Show moon icon in dark mode */
html:not(.sunlight) #theme-switch svg:first-child {
  display: block;
}

/* Show sun icon in light mode */
html.sunlight #theme-switch svg:last-child {
  display: block;
}


    </style>
</head>

  <body>
   <button id="theme-switch" aria-label="Toggle Theme">
    <!-- Moon icon (dark mode) -->
    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px">
      <path d="M480-280q-83 0-141.5-58.5T280-480q0-83 58.5-141.5T480-680q83 0 141.5 58.5T680-480q0 83-58.5 141.5T480-280ZM200-440H40v-80h160v80Zm720 0H760v-80h160v80ZM440-760v-160h80v160h-80Zm0 720v-160h80v160h-80ZM256-650l-101-97 57-59 96 100-52 56Zm492 496-97-101 53-55 101 97-57 59Zm-98-550 97-101 59 57-100 96-56-52ZM154-212l101-97 55 53-97 101-59-57Z"/>
    </svg>
    <!-- Sun icon (light mode) -->
    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px">
      <path d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Z"/>
    </svg>
  </button>
    <div class="main">
      <div id="tableContainer" class="container"></div>
      <br>
      <div class="button-wrapper">
        <button class="button" id="sendBackend" onclick="submitAvailability()">Next</button>
      </div>
    </div>
    <script>
  // Toggle sunlight theme on click
  document.getElementById('theme-switch').addEventListener('click', () => {
    document.documentElement.classList.toggle('sunlight');
  });
</script>

  </body>
    
            
    <script>
    	var rooms=[];
	var times=[];
	var days=[];
	    
function generateScheduleTable(allTimes, dayPeriods, rooms) {
    const container = document.getElementById("tableContainer"); // Where the table goes
    container.innerHTML = ""; // Clear previous table

    Object.entries(dayPeriods).forEach(([day, periods]) => {
        // Create table container with spacing
        const tableWrapper = document.createElement("div");

        // Create table
        const table = document.createElement("table");
        table.border = "1";
        table.style.width = "100%"; // Full width for better layout
        table.style.borderCollapse = "collapse"; // Clean table style

        // Create header row with centered editable title
        const headerRow = document.createElement("tr");
        const dayCell = document.createElement("th");
        dayCell.colSpan = rooms.length + 2; // Merge across all columns (+1 for dropdown column)
        dayCell.style.textAlign = "center"; // Center the text
        dayCell.style.backgroundColor = "#360000";
        const dayInput = document.createElement("input");
        dayInput.type = "text";
        dayInput.value = day;
        dayInput.style.width="400px";
        dayInput.style.textAlign = "center"; // Ensure text aligns inside input
        dayCell.appendChild(dayInput);
        headerRow.appendChild(dayCell);
        table.appendChild(headerRow);

        // Create room header row
        const roomRow = document.createElement("tr");
        const emptyHeader = document.createElement("th");
        emptyHeader.textContent = "Periods";
        roomRow.appendChild(emptyHeader);

        const periodLabelHeader = document.createElement("th");
        periodLabelHeader.textContent = "Select Period";
        roomRow.appendChild(periodLabelHeader); // New column for dropdowns

        rooms.forEach(room => {
            const roomCell = document.createElement("th");
            roomCell.textContent = room;
            roomRow.appendChild(roomCell);
        });
        table.appendChild(roomRow);

periods.forEach(period => {
    const periodRow = document.createElement("tr");

    // Period Label Cell
    const periodCell = document.createElement("td");
    periodCell.textContent = period;
    periodRow.appendChild(periodCell);

    // Dropdown Column
    const dropdownCell = document.createElement("td");
    const dropdown = document.createElement("select");
    dropdown.style = "cursor: pointer";

    /*for (let i = 1; i <= 8; i++) {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = `${i}`;
        dropdown.appendChild(option);
    }*/

const dropdownStart = 2; // Starting value
const dropdownMax = 8;   // Max value you want

for (let i = dropdownStart; i <= dropdownMax; i++) {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = `${i}`;
    dropdown.appendChild(option);
}

// Set default selected value to 2
dropdown.value = dropdownStart;
	

    dropdownCell.appendChild(dropdown);
    periodRow.appendChild(dropdownCell);

    // Room availability checkboxes
    rooms.forEach(() => {
        const cell = document.createElement("td");
        const checkbox = document.createElement("input");
        checkbox.style = "cursor: pointer";
        checkbox.type = "checkbox";
        checkbox.checked = true;
        cell.appendChild(checkbox);
        periodRow.appendChild(cell);
    });

    table.appendChild(periodRow);
});

	    // Create period rows
/*
periods.forEach(period => {
    const periodRow = document.createElement("tr");

    // Period Label Cell
    const periodCell = document.createElement("td");
    periodCell.textContent = period;
    periodRow.appendChild(periodCell);

    // Dropdown Column
    const dropdownCell = document.createElement("td");
    const dropdown = document.createElement("select");
    dropdown.style = "cursor: pointer";

const dropdownStart = 2; // Starting value
const dropdownMax = 8;   // Max value you want

for (let i = dropdownStart; i <= dropdownMax; i++) {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = `${i}`;
    dropdown.appendChild(option);
}

// Set default selected value to 2
dropdown.value = dropdownStart;
	

    dropdownCell.appendChild(dropdown);
    periodRow.appendChild(dropdownCell);

    // Room availability checkboxes
    rooms.forEach(() => {
        const cell = document.createElement("td");
        const checkbox = document.createElement("input");
        checkbox.style = "cursor: pointer";
        checkbox.type = "checkbox";
        checkbox.checked = true;
        cell.appendChild(checkbox);
        periodRow.appendChild(cell);
    });

    table.appendChild(periodRow);
});
*/	    
	    
        tableWrapper.appendChild(table);
        container.appendChild(tableWrapper);
    });
}

// **Example Usage**
/*const allTimes = ["Pd2, Tuesday", "Pd3, Thursday", "Pd3, Tuesday", "Pd5, Thursday"];
const dayPeriods = {
    "Day 1": ["Pd2, Tuesday", "Pd3, Thursday"],
    "Day 2": ["Pd3, Tuesday", "Pd5, Thursday"]
};
const rooms = ["Room 1", "Room 2", "Room 3"];
*/

function collectTableData() {
    let roomAvailability = {};
    let timeToPeriod = {};

    document.querySelectorAll("table").forEach((table) => {
        // Get the day name from the editable text box
        let day = table.querySelector("th input").value.trim();

        table.querySelectorAll("tr").forEach((row, rowIndex) => {
            if (rowIndex === 0 || rowIndex === 1) return; // Skip headers

            let periodText = row.cells[0].textContent.trim(); // Time (Pd2, Tuesday)
            let selectedPeriod = row.cells[1].querySelector("select").value.trim(); // Dropdown period

            // Store period mapping
            timeToPeriod[periodText] = selectedPeriod.toString();

            // Iterate through room columns (starting from cell index 2)
            row.querySelectorAll("td:nth-child(n+3)").forEach((cell, cellIndex) => {
                let roomName = document.querySelectorAll("table tr:nth-child(2) th")[cellIndex+2].textContent.trim();

                if (!roomAvailability[roomName]) roomAvailability[roomName] = {};
                if (!roomAvailability[roomName][day]) roomAvailability[roomName][day] = [];

                // If checkbox is checked, add time to the room's availability list
                let checkbox = cell.querySelector("input[type='checkbox']");
                if (checkbox && checkbox.checked) {
                    roomAvailability[roomName][day].push(periodText);
                }
            });
        });
    });

    //console.log("Room Availability:", JSON.stringify(roomAvailability, null, 2));
    //console.log("Time to Period Mapping:", JSON.stringify(timeToPeriod, null, 2));
    console.log(JSON.stringify(roomAvailability));
    console.log(JSON.stringify(timeToPeriod));
	
    return [roomAvailability, timeToPeriod];
}


function collectDayNameChanges(dayPeriods) {
    let dayNameChanges = {};

    document.querySelectorAll("table").forEach((table, index) => {
        let oldDayName = Object.keys(dayPeriods)[index]; // Get original day name
        let newDayName = table.querySelector("th input").value.trim(); // Get user-edited name

        if (oldDayName !== newDayName) {
            dayNameChanges[oldDayName] = newDayName; // Store change
        }
    });

    console.log("Day Name Changes:", JSON.stringify(dayNameChanges, null, 2));
    return dayNameChanges;
}
	    
// Call function to generate table
//generateScheduleTable(allTimes, dayPeriods, rooms);

        fetch('/getRoomsAndTimes')
	    .then(res => res.json())
	    .then(data => {
	      rooms=data.rooms;
	      times=data.times;
	      days=data.days;
	      generateScheduleTable(times, days, rooms)
	    })
	.catch(err => console.error("Failed to fetch room data:", err));
        
        function submitAvailability() {
            console.log("Sending data to backend...");

            let oldData = collectTableData();
    	    let dayOrder = collectDayNameChanges(days);
            
            
            // Prepare the data to send
            const data = {
                roomsToTimes: oldData[0],
                periodMap: oldData[1],
		dayOrder: dayOrder
            };
            console.log(data);
            
            // Send the data to the backend
            fetch('/submit_availability', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log("‚úÖ Received response from backend!");
                return response.text();
            })
            .then(message => {
                console.log("üì¢ Backend says:", message);
                //alert(message); // still alert the user nicely
            })
            .catch(error => {
                console.error('‚ùå Error:', error);
            });
            window.location.href = "/topics";
        }
        
    </script>
</body>
</html>
