<!DOCTYPE html>
<html>
<head>
	<link href="https://fonts.googleapis.com/css2?family=Assistant&display=swap" rel="stylesheet">
  <title>adjustingRoomQuantity</title>
  <script defer>
    const THEME_KEY = "theme";
    const DARK = "dark";
    const LIGHT = "sunlight";

    const html = document.documentElement;

    function getPreferredTheme() {
      const stored = localStorage.getItem(THEME_KEY);
      if (stored) return stored;

      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      return prefersDark ? DARK : LIGHT;
    }

    function applyTheme(theme) {
      if (theme === LIGHT) {
        html.classList.add("sunlight");
      } else {
        html.classList.remove("sunlight");
      }
      html.setAttribute("data-theme", theme);
    }

    function toggleTheme() {
      const current = html.getAttribute("data-theme") || getPreferredTheme();
      const newTheme = current === DARK ? LIGHT : DARK;

      applyTheme(newTheme);
      localStorage.setItem(THEME_KEY, newTheme);
    }

    window.addEventListener("storage", (e) => {
      if (e.key === THEME_KEY) {
        applyTheme(e.newValue);
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      applyTheme(getPreferredTheme());

      const button = document.getElementById("theme-switch");
      if (button) {
        button.addEventListener("click", toggleTheme);
      }
    });
  </script>

  <style>
    :root {
      --base-color: linear-gradient(180deg, #360000, #130101);
      --text-color: white;
      --fill-color: #fff7f7;
      --base-variant: #ff2222;
   
    }

    html.sunlight {
      --base-color: linear-gradient(180deg, #fff6eeff, #ffded9 );;
      --text-color: #B51111;
      --bg-color: #c6afaf;
      --fill-color: #550000;
      --base-variant: #edbfbf;
      --header-color: #7a2e41;
    }
    body { 
    	margin: 0;
        padding: 40px;
        display: flex;
    	background-image:var(--base-color);
        align-items: center;
        justify-content: center;
        font-family: 'Assistant', sans-serif;

    }
 
    

.sunlight{
 background-color:#7a2e41;
}

/* Optional wrapper if you want extra control */
.wrapper {
  width: 100%;
  max-width: 680px; /* 600px form + 40px margin each side */
  padding: 0 40px;
  box-sizing: border-box;
}

.formContainer {
  background-color: #c6afaf;
  padding: 40px;
  width: 100%;      /* fill wrapper width */
  max-width: 600px; /* constrain max width */
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
  display: flex;
  flex-direction: column;
  text-align: center;
  border-radius: 12px;
  margin: 0 auto;   /* center inside wrapper */
}
.formContainer > * {
  width: 100%;
  box-sizing: border-box;
}

    
    .room { 
      padding: 10px; 
      margin-top: 20px;
      margin-bottom: 20px; 
      color: white;
      width: 100%;
      background-color: #cb5151ff;
      text-align: center;
      border-radius: 12px;
      }
      
    .topic-row { 
    text-align: left;
    margin-bottom: 8px; 
    color: white;
    }
    
    h2{
    	text-align: center;
        color:white;
    }

	.header{
    	background-color:#7a2e41;
        text-align: center;
        color: white;
        width: 100%;
        font-family: Arial, sans-serif;
        padding: 10px;
        border-radius: 12px;
    }
    
    button[type="submit"] {
      background-color: #B51111;
      color: white;
      padding: 16px 32px;
      border: none;
      font-size: 20px;
      cursor: pointer;
      margin: 15px auto 0 auto;
      display: block;
      width: 100%;
      border-radius: 12px;
      font-weight: bold;
      /* transition: background-color 0.3s ease, box-shadow 0.3s ease; */
    }

    button[type="submit"]:hover {
      background-color: #870c0cff;
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }


    /* Menu */
    .menu {
      position: absolute;
      top: 30px;
      right: 30px;
      width: 35px;
      height: 25px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      border-radius: 2px;
      justify-content: space-between;
    }

    .menu div {
      height: 5px;
      background-color: white;
      border-radius: 2px;
    }

    /* Dropdown Menu */
    .dropdown {
      display: none;
      position: absolute;
      top: 70px;
      right: 30px;
      background-color: #d9d9d9;
      border: 1px solid #888;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
      width: 200px;
      border-radius: 2px;
      z-index: 1000;
    }

    .dropdown a {
      display: block;
      padding: 16px 20px;
      text-decoration: none;
      font-weight: bold;
      color: black;
      border-bottom: 1px solid #aaa;
      border-radius: 2px;
    }

    .dropdown a:last-child {
      color: red;
      border-bottom: none;
    }

    .dropdown a:hover {
      background-color: #ccc;
      transform: scale(1.05);
    }

#app {
    width: 100%; /* ✅ Makes it match .formContainer */
}
 #theme-switch {
  height: 50px;
  width: 50px;
  padding: 0;
  border-radius: 50%;
  background-color: var(--base-variant);
  display: flex;
  justify-content: center;
  align-items: center;
  position: fixed;
  top: 20px;
  left: 20px;
  cursor: pointer;
  border: none;
}

/* Hide all icons by default */
#theme-switch svg {
  display: none;
  fill: var(--fill-color);
}

/* Show moon icon in dark mode */
html:not(.sunlight) #theme-switch svg:first-child {
  display: block;
}

/* Show sun icon in light mode */
html.sunlight #theme-switch svg:last-child {
  display: block;
}

	  
  </style>
</head>
<body>
<!-- Menu Icon -->
<button id="theme-switch" aria-label="Toggle Theme">
    <!-- Moon icon (dark mode) -->
    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px">
      <path d="M480-280q-83 0-141.5-58.5T280-480q0-83 58.5-141.5T480-680q83 0 141.5 58.5T680-480q0 83-58.5 141.5T480-280ZM200-440H40v-80h160v80Zm720 0H760v-80h160v80ZM440-760v-160h80v160h-80Zm0 720v-160h80v160h-80ZM256-650l-101-97 57-59 96 100-52 56Zm492 496-97-101 53-55 101 97-57 59Zm-98-550 97-101 59 57-100 96-56-52ZM154-212l101-97 55 53-97 101-59-57Z"/>
    </svg>
    <!-- Sun icon (light mode) -->
    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px">
      <path d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Z"/>
    </svg>
  </button>
  <div class="menu" onclick="toggleMenu()">
    <div></div>
    <div></div>
    <div></div>
  </div>

  <!-- Dropdown Popup Menu -->
  <div id="dropdownMenu" class="dropdown">
    <a href="#">Return to Home</a>
    <a href="#">Help</a>
    <a href="#">Logout</a>
  </div>

  <script>
    function toggleMenu() {
      const menu = document.getElementById('dropdownMenu');
      menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    }

    // hide menu if clicking outside
    document.addEventListener('click', function(event) {
      const menu = document.getElementById('dropdownMenu');
      const hamburger = document.querySelector('.menu');
      if (!menu.contains(event.target) && !hamburger.contains(event.target)) {
        menu.style.display = 'none';
      }
    });
  </script>

  
  
<div class="formContainer">
<div class="header">
  <h2>Project Topics</h2>
</div>

  <div id="app"></div>
<button type="submit" onclick="logOutput()">Set Topics</button>
  
  
  
 



 <script>
/*
    const topics = {
      "Biology/Biotech": 14,
      "Computer Science/AI": 22,
      "Chemistry/Materials Science": 1,
      "Engineering": 8,
      "Math": 3,
      "Physics": 2,
      "Earth & Space Systems Science": 5,
      "Economics & Social Issues": 3
    };

    const rooms = {
      "1602": 20,
      "1620": 20,
      "1702": 20
    };
    */

    var assignments = {};
	 var rooms={};
	 var topics={};
fetch('/get_data')
    .then(res => res.json())
    .then(data => {
      rooms=data.capacityDict;
      topics=data.topics;
	console.log(JSON.stringify(rooms));
	console.log(JSON.stringify(topics));
	
    var roomCurrentCapacities={};
    
    //const assignments = {};
    const totalAssignedPerTopic = {};

    for (const room in rooms) {
      assignments[room] = {};
      roomCurrentCapacities[room]=0;
    }
    for (const topic in topics) {
      totalAssignedPerTopic[topic] = 0;
    }

    const app = document.getElementById("app");

    function totalAssignedInRoom(room) {
      return Object.values(assignments[room]).reduce((a,b) => a + b, 0);
    }

    
    const availabilitySpans = {}; 

	 
	 
    for (const room in rooms) {
      const capacity = rooms[room];
      var currentCapacity=roomCurrentCapacities[room];
      const roomDiv = document.createElement("div");
      roomDiv.className = "room";

      const title = document.createElement("h3");
      title.textContent = `${room} (${currentCapacity}/${capacity})`;
      roomDiv.appendChild(title);

      for (const topic in topics) {
        const topicCount = topics[topic];

        const row = document.createElement("div");
        row.className = "topic-row";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = `${room}-${topic}-chk`;
        checkbox.dataset.room = room;
        checkbox.dataset.topic = topic;

        const label = document.createElement("label");
        label.htmlFor = checkbox.id;
        label.textContent = topic + " ";

        const availabilitySpan = document.createElement("span");
        availabilitySpan.className = "availability";
        availabilitySpan.textContent = `(Available: ${topicCount})`;
        label.appendChild(availabilitySpan);

        // Save the span in the array for this topic
        if (!availabilitySpans[topic]) {
          availabilitySpans[topic] = [];
        }
        availabilitySpans[topic].push(availabilitySpan);

        const input = document.createElement("input");
        input.type = "number";
        input.min = 1;
        input.value = "";
        input.disabled = true;
        input.style.marginLeft = "10px";
        input.style.width = "50px";

        assignments[room][topic] = 0;

        checkbox.addEventListener("change", () => {
          const r = checkbox.dataset.room;
          const t = checkbox.dataset.topic;

          if (checkbox.checked) {
            input.disabled = false;
            /*input.value = 1;
            assignments[r][t] = 1;
            totalAssignedPerTopic[t] += 1;*/
			var leftOver = topics[topic] - totalAssignedPerTopic[topic];
            currentCapacity=roomCurrentCapacities[room];
            var defaultValue=Math.min(capacity-currentCapacity,leftOver);
            input.value = defaultValue;
            assignments[r][t] = defaultValue;
            totalAssignedPerTopic[t] += defaultValue;
            currentCapacity+=defaultValue;
            roomCurrentCapacities[room]=currentCapacity;
          } else {
            input.disabled = true;
            totalAssignedPerTopic[t] -= assignments[r][t];
            currentCapacity=roomCurrentCapacities[room];
            currentCapacity-=assignments[r][t];
            roomCurrentCapacities[room]=currentCapacity;
            
            assignments[r][t] = 0;
            input.value = "";
          }
          
          title.textContent = `${room} (${currentCapacity}/${capacity})`;
          updateAvailability(t);
        });

        input.addEventListener("input", () => {
          const r = checkbox.dataset.room;
          const t = checkbox.dataset.topic;
          let val = parseInt(input.value) || 0;

          if (val < 1) {
            //val = 1;
            //input.value = val;
          }

          const roomTotalWithoutCurrent = totalAssignedInRoom(r) - assignments[r][t];
          if (val + roomTotalWithoutCurrent > rooms[r]) {
            val = rooms[r] - roomTotalWithoutCurrent;
            input.value = val;
          }

          const topicTotalWithoutCurrent = totalAssignedPerTopic[t] - assignments[r][t];
          if (val + topicTotalWithoutCurrent > topics[t]) {
            val = topics[t] - topicTotalWithoutCurrent;
            input.value = val;
          }

          totalAssignedPerTopic[t] += val - assignments[r][t];
          assignments[r][t] = val;

	  roomCurrentCapacities[r] = totalAssignedInRoom(r);  
    	  title.textContent = `${r} (${roomCurrentCapacities[r]}/${rooms[r]})`;
		
          updateAvailability(t);
        });

        row.appendChild(checkbox);
        row.appendChild(label);
        row.appendChild(input);
        roomDiv.appendChild(row);
      }

      app.appendChild(roomDiv);
    }
	 
    function updateAvailability(topic) {
  const remaining = topics[topic] - totalAssignedPerTopic[topic];
  if (availabilitySpans[topic]) {
    availabilitySpans[topic].forEach(span => {
      span.textContent = `(Available: ${remaining})`;
      span.style.fontWeight = remaining === 0 ? "800" : "200";
    });
  }
}

	 })
    .catch(err => console.error("Failed to fetch room data:", err));


    function logOutput() {
      const cleanOutput = {};
      for (const room in assignments) {
        cleanOutput[room] = {};
        for (const topic in assignments[room]) {
          if (assignments[room][topic] > 0) {
            cleanOutput[room][topic] = assignments[room][topic];
          }
        }
      }
      console.log("Final Output:", cleanOutput);
            const data = {
                topicDistribution: cleanOutput
            };
            console.log(data);
            
            // Send the data to the backend
            fetch('/setNewTopics', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log("✅ Received response from backend!");
		window.location.href = "/moderator";
                return response.text();
            })
            .then(message => {
                console.log("📢 Backend says:", message);
                //alert(message); // still alert the user nicely
            })
            .catch(error => {
                console.error('❌ Error:', error);
            });
	    
      //alert("Check the console for the final output!");
    }
  </script>
 </div>
</body>
</html>
